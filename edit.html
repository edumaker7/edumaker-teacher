<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°•ì˜ ì •ë³´ ìˆ˜ì • - EDUMAKER</title>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f1f3f5; padding: 20px; margin: 0; }
        .edit-box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); max-width: 650px; margin: 0 auto; }
        h2 { color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        .input-group { margin-bottom: 18px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #444; font-size: 14px; }
        .required { color: #d93025; margin-left: 3px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        .row-group { display: flex; gap: 15px; margin-bottom: 18px; }
        .half-input { flex: 1; }
        .address-row { display: flex; gap: 10px; }
        .addr-search-group { flex: 7; display: flex; gap: 5px; }
        .addr-search-group input { flex: 1; cursor: pointer; background-color: #fdfdfd; }
        .btn-addr-search { width: 50px; background-color: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        #classRoom { flex: 3; }
        .schedule-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee; }
        .schedule-row input[type="date"] { flex: 2; min-width: 130px; } 
        .time-picker-group { display: flex; gap: 2px; align-items: center; flex: 4; justify-content: flex-end; }
        .time-picker-group select { padding: 8px 2px; text-align: center; font-size: 13px; height: 42px; width: auto; }
        .hour-select, .min-select { width: 55px !important; }
        .ampm-select { width: 65px !important; }
        .btn-update { width: 100%; padding: 16px; background-color: #0056b3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 17px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="edit-box">
    <h2>ğŸ“ ê°•ì˜ ì •ë³´ ìˆ˜ì •</h2>
    <div class="row-group">
        <div class="half-input"><label>ê°•ì‚¬ ì„±í•¨</label><input type="text" id="teacherName" readonly style="background:#f1f1f1;"></div>
        <div class="half-input"><label>ê°•ì‚¬ ì´ë©”ì¼</label><input type="text" id="teacherEmail" readonly style="background:#f1f1f1;"></div>
    </div>
    <div class="row-group">
        <div class="half-input"><label>ê°•ì˜ì²˜ <span class="required">*</span></label><input type="text" id="client"></div>
        <div class="half-input"><label>ê°•ì¢Œëª… <span class="required">*</span></label><input type="text" id="subject"></div>
    </div>
    <div class="input-group">
        <label>ê°•ì˜ ì¥ì†Œ <span class="required">*</span></label>
        <div class="address-row">
            <div class="addr-search-group"><input type="text" id="address" placeholder="ì£¼ì†Œ ê²€ìƒ‰" readonly onclick="openDaumPostcode()"><button type="button" class="btn-addr-search" onclick="openDaumPostcode()">ğŸ”</button></div>
            <input type="text" id="classRoom" placeholder="ìƒì„¸ì¥ì†Œ">
        </div>
    </div>
    <div class="input-group">
        <label>ì—­í•  <span class="required">*</span></label>
        <select id="roleSelect"><option value="ì£¼ê°•ì‚¬">ì£¼ê°•ì‚¬</option><option value="ë³´ì¡°ê°•ì‚¬">ë³´ì¡°ê°•ì‚¬</option><option value="ì•ˆì „ìš”ì›">ì•ˆì „ìš”ì›</option><option value="direct">ì§ì ‘ ì…ë ¥ (ê¸°íƒ€)</option></select>
        <input type="text" id="roleInputDirect" placeholder="ì—­í•  ì§ì ‘ ì…ë ¥" style="margin-top:5px; display:none;">
    </div>
    <div class="input-group">
        <label>êµìœ¡ ì¼ì • <span class="required">*</span></label>
        <div id="scheduleContainer"></div>
        <button type="button" onclick="addScheduleRow()" style="width:100%; padding:10px; background:#51cf66; color:white; border:none; border-radius:8px; cursor:pointer;">+ ì¼ì • ì¶”ê°€</button>
    </div>
    <div class="row-group">
        <div class="half-input"><label>ì´ ê°•ì˜ ì‹œê°„</label><input type="number" id="classHours"></div>
        <div class="half-input"><label>ì‹œê°„ë‹¹ ê°•ì‚¬ë£Œ</label><input type="text" id="hourlyRate"></div>
    </div>
    <div class="row-group">
        <div class="half-input"><label>ì¶”ê°€ ë¹„ìš©</label><input type="text" id="additionalCost"></div>
        <div class="half-input"><label>ìˆ˜ìˆ˜ë£Œìœ¨ (%)</label><input type="number" id="commissionRate"></div>
    </div>
    <button class="btn-update" id="updateBtn">ìˆ˜ì • ë‚´ìš© ì €ì¥í•˜ê¸°</button>
</div>

<script>
    function openDaumPostcode() {
        new daum.Postcode({ oncomplete: function(data) {
            document.getElementById("address").value = data.roadAddress || data.jibunAddress;
            document.getElementById("classRoom").focus();
        }}).open();
    }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw",
        authDomain: "edumaker-teacher-d97ba.firebaseapp.com",
        projectId: "edumaker-teacher-d97ba",
        storageBucket: "edumaker-teacher-d97ba.firebasestorage.app",
        messagingSenderId: "532708143359",
        appId: "1:532708143359:web:89b9933da4c868127ddcca",
        measurementId: "G-JJ1TF77VBJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const urlParams = new URLSearchParams(window.location.search);
    const docId = urlParams.get('id');

    let originalData = {}; // ğŸ”¥ ì›ë³¸ ë°ì´í„°ë¥¼ ì €ì¥í•  ë³€ìˆ˜

    function createHourOptions(selected) {
        let options = ''; for(let i=1; i<=12; i++) { let val = i.toString().padStart(2, '0'); options += `<option value="${val}" ${val === selected ? 'selected' : ''}>${val}</option>`; } return options;
    }
    function createMinuteOptions(selected) {
        let options = ''; for(let i=0; i<60; i+=5) { let val = i.toString().padStart(2, '0'); options += `<option value="${val}" ${val === selected ? 'selected' : ''}>${val}</option>`; } return options;
    }

    window.addScheduleRow = function(dateValue = '', timeString = '') {
        const container = document.getElementById('scheduleContainer');
        const row = document.createElement('div');
        row.className = 'schedule-row';
        let t = { sAmpm: 'ì˜¤í›„', sH: '02', sM: '00', eAmpm: 'ì˜¤í›„', eH: '04', eM: '00' };
        if(timeString) {
            try {
                const parts = timeString.split(' ~ ');
                const start = parts[0].split(' '); const end = parts[1].split(' ');
                t.sAmpm = start[0]; t.sH = start[1].split(':')[0]; t.sM = start[1].split(':')[1];
                t.eAmpm = end[0]; t.eH = end[1].split(':')[0]; t.eM = end[1].split(':')[1];
            } catch(e) {}
        }
        row.innerHTML = `
            <input type="date" class="input-date" value="${dateValue}">
            <div class="time-picker-group">
                <select class="ampm-start"><option ${t.sAmpm==='ì˜¤ì „'?'selected':''}>ì˜¤ì „</option><option ${t.sAmpm==='ì˜¤í›„'?'selected':''}>ì˜¤í›„</option></select>
                <select class="hour-start hour-select">${createHourOptions(t.sH)}</select>:<select class="min-start min-select">${createMinuteOptions(t.sM)}</select>
                <span>~</span>
                <select class="ampm-end"><option ${t.eAmpm==='ì˜¤ì „'?'selected':''}>ì˜¤ì „</option><option ${t.eAmpm==='ì˜¤í›„'?'selected':''}>ì˜¤í›„</option></select>
                <select class="hour-end hour-select">${createHourOptions(t.eH)}</select>:<select class="min-end min-select">${createMinuteOptions(t.eM)}</select>
            </div>
            <button type="button" onclick="this.parentElement.remove()">-</button>`;
        container.appendChild(row);
    }

    if (docId) {
        getDoc(doc(db, "assignments", docId)).then((docSnap) => {
            if (docSnap.exists()) {
                originalData = docSnap.data(); // ğŸ”¥ ì›ë³¸ ë³µì‚¬
                document.getElementById('teacherName').value = originalData.teacherName;
                document.getElementById('teacherEmail').value = originalData.teacherEmail;
                document.getElementById('client').value = originalData.client;
                document.getElementById('subject').value = originalData.subject;
                document.getElementById('address').value = originalData.address;
                document.getElementById('classRoom').value = originalData.classRoom || '';
                document.getElementById('classHours').value = originalData.classHours;
                document.getElementById('hourlyRate').value = Number(originalData.hourlyRate).toLocaleString();
                document.getElementById('additionalCost').value = Number(originalData.additionalCost || 0).toLocaleString();
                document.getElementById('commissionRate').value = originalData.commissionRate;

                const dates = originalData.date ? originalData.date.split(', ') : [];
                const times = originalData.time ? originalData.time.split(', ') : [];
                dates.forEach((d, i) => addScheduleRow(d, times[i]));
            }
        });
    }

    document.getElementById('updateBtn').onclick = async () => {
        // ìƒˆ ë°ì´í„° ìˆ˜ì§‘
        const newAddress = document.getElementById('address').value;
        const newClassRoom = document.getElementById('classRoom').value;
        const newClassHours = Number(document.getElementById('classHours').value);
        const newHourlyRate = Number(document.getElementById('hourlyRate').value.replace(/,/g, ''));
        const newAdditionalCost = Number(document.getElementById('additionalCost').value.replace(/,/g, ''));
        
        const rows = document.querySelectorAll('.schedule-row');
        let dList = []; let tList = [];
        rows.forEach(row => {
            const d = row.querySelector('.input-date').value;
            const ts = `${row.querySelector('.ampm-start').value} ${row.querySelector('.hour-start').value}:${row.querySelector('.min-start').value}`;
            const te = `${row.querySelector('.ampm-end').value} ${row.querySelector('.hour-end').value}:${row.querySelector('.min-end').value}`;
            if(d) { dList.push(d); tList.push(`${ts} ~ ${te}`); }
        });
        const newDate = dList.join(', ');
        const newTime = tList.join(', ');

        // ğŸ”¥ ë³€ê²½ ì—¬ë¶€ ê°œë³„ ì²´í¬
        const changeLog = {
            isUpdated: true,
            status: "ë°°ì •ì™„ë£Œ",
            isPaidTeacher: false,
            isPaidService: false,
            // ê°œë³„ í•„ë“œ ë¹„êµ
            changed_address: (newAddress !== originalData.address),
            changed_classRoom: (newClassRoom !== (originalData.classRoom || '')),
            changed_schedule: (newDate !== originalData.date || newTime !== originalData.time),
            changed_money: (newClassHours !== originalData.classHours || newHourlyRate !== originalData.hourlyRate || newAdditionalCost !== (originalData.additionalCost || 0))
        };

        try {
            await updateDoc(doc(db, "assignments", docId), {
                client: document.getElementById('client').value,
                subject: document.getElementById('subject').value,
                address: newAddress,
                classRoom: newClassRoom,
                date: newDate,
                time: newTime,
                classHours: newClassHours,
                hourlyRate: newHourlyRate,
                additionalCost: newAdditionalCost,
                serviceFee: Math.floor((newClassHours * newHourlyRate) * (Number(document.getElementById('commissionRate').value) / 100)),
                commissionRate: Number(document.getElementById('commissionRate').value),
                ...changeLog // ì²´í¬í•œ ë³€ê²½ì‚¬í•­ í•©ì¹˜ê¸°
            });
            alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.close();
        } catch (e) { alert("ì˜¤ë¥˜: " + e.message); }
    };
</script>
</body>
</html>