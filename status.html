<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—ë“€ë©”ì´ì»¤ - ë°°ì • í˜„í™© ë° ì •ì‚° ê´€ë¦¬</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f4f8; padding: 40px; margin: 0; }
        .list-container { max-width: 1600px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f3f5; padding-bottom: 20px; }
        .logo { font-size: 24px; font-weight: 800; color: #0056b3; cursor: pointer; text-decoration: none; }
        h2 { color: #1a1a1a; margin: 0; font-size: 22px; }
        
        .filter-bar { margin-bottom: 25px; display: flex; align-items: center; gap: 20px; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; }
        .filter-item { display: flex; align-items: center; gap: 8px; }
        .filter-bar select { padding: 10px 15px; border-radius: 6px; border: 1px solid #ced4da; font-size: 14px; background-color: white; }
        
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border-bottom: 1px solid #eee; padding: 14px 10px; text-align: left; font-size: 13px; vertical-align: top; word-break: keep-all; word-wrap: break-word; }
        
        th { background-color: #fcfcfc; color: #495057; font-weight: 700; border-top: 2px solid #0056b3; line-height: 1.5; }
        
        th:nth-child(1) { width: 160px; } /* êµìœ¡ì¼ì/ì‹œê°„ */
        th:nth-child(2) { width: 160px; } /* ì´ë¦„/ì´ë©”ì¼ */
        th:nth-child(3) { width: 170px; } /* ê°•ì˜ì²˜/ê°•ì¢Œëª… */
        th:nth-child(4) { width: 80px; }  /* ì—­í•  */
        th:nth-child(5) { width: 110px; } /* ê°•ì˜ì‹œê°„/ì‹œê¸‰ */
        th:nth-child(6) { width: 130px; } /* ì¶”ê°€ë¹„ìš©/í•©ê³„ */
        th:nth-child(7) { width: 100px; } /* ì„œë¹„ìŠ¤ì´ìš©ë£Œ */
        th:nth-child(8) { width: 120px; } /* ë¹„ê³  */

        .schedule-item { margin-bottom: 8px; border-bottom: 1px dashed #f1f3f5; padding-bottom: 4px; }
        .schedule-item:last-child { border-bottom: none; }
        .date-part { font-weight: bold; color: #333; display: block; }
        .time-part { color: #0056b3; font-size: 12px; display: block; margin-top: 2px; }

        .text-main { font-weight: bold; color: #333; display: block; margin-bottom: 3px; line-height: 1.3; }
        .text-sub { font-size: 12px; color: #888; display: block; line-height: 1.3; }

        .money-total { font-weight: bold; color: #d93025; font-size: 13px; display: block; }
        .money-add { font-size: 11px; color: #28a745; display: block; margin-bottom: 2px; }

        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; display: inline-block; }
        .status-wait { background: #fff3cd; color: #856404; }
        .status-ok { background: #d4edda; color: #155724; }
        
        .chk-group { display: flex; flex-direction: column; gap: 6px; font-size: 12px; }
        .chk-group label { display: flex; align-items: center; cursor: pointer; }
        .chk-group input { margin-right: 5px; }

        .btn-group { display: flex; gap: 4px; flex-wrap: wrap; }
        .btn-edit { padding: 6px 10px; background-color: #0056b3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .btn-delete { padding: 6px 10px; background-color: #ff4d4f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }

        .btn-back {
            background-color: #0056b3; color: white; text-decoration: none; padding: 10px 22px;
            border-radius: 8px; font-size: 14px; font-weight: 600; transition: background 0.2s;
        }
        .btn-back:hover { background-color: #004494; }
    </style>
</head>
<body>

<div class="list-container">
    <div class="header">
        <a href="admin.html" class="logo">EDUMAKER ADMIN</a>
        <h2>ğŸ“‹ ë°°ì • í˜„í™© ë° ì •ì‚° ê´€ë¦¬</h2>
        <a href="admin.html" class="btn-back">ê°•ì˜ ë°°ì • í˜ì´ì§€ë¡œ</a>
    </div>
    
    <div class="filter-bar">
        <div class="filter-item">
            <strong>ğŸ” ê°•ì‚¬ í•„í„° :</strong>
            <select id="teacherFilter" onchange="filterAssignments()">
                <option value="all">ì „ì²´ ê°•ì‚¬</option>
            </select>
        </div>
        <div class="filter-item">
            <strong>ğŸ« ê°•ì˜ì²˜ í•„í„° :</strong>
            <select id="clientFilter" onchange="filterAssignments()">
                <option value="all">ì „ì²´ ê°•ì˜ì²˜</option>
            </select>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>êµìœ¡ì¼ì<br>êµìœ¡ì‹œê°„</th>
                <th>ì´ë¦„<br>ì´ë©”ì¼</th>
                <th>ê°•ì˜ì²˜<br>ê°•ì¢Œëª…</th>
                <th>ì—­í• </th>
                <th>ê°•ì˜ì‹œê°„<br>ì‹œê°„ë‹¹ ê°•ì‚¬ë£Œ</th>
                <th>ì¶”ê°€ë¹„ìš©<br>ì´ í•©ê³„</th>
                <th>ì„œë¹„ìŠ¤ ì´ìš©ë£Œ<br>(ìˆ˜ìˆ˜ë£Œìœ¨)</th>
                <th>ë¹„ê³ </th>
                <th>ê°•ì‚¬í™•ì¸</th>
                <th>ìƒì„¸ ì •ì‚° ì²˜ë¦¬</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody id="admin-list-body">
            <tr><td colspan="11" style="text-align:center; padding:40px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
        </tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw",
        authDomain: "edumaker-teacher-d97ba.firebaseapp.com",
        projectId: "edumaker-teacher-d97ba",
        storageBucket: "edumaker-teacher-d97ba.firebasestorage.app",
        messagingSenderId: "532708143359",
        appId: "1:532708143359:web:89b9933da4c868127ddcca",
        measurementId: "G-JJ1TF77VBJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allAssignments = [];

    // ì •ì‚° ìƒíƒœ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
    window.updatePayStatus = async function(docId, field, isChecked) {
        try {
            await updateDoc(doc(db, "assignments", docId), { [field]: isChecked });
        } catch (error) { alert("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨"); }
    }

    // ğŸ”¥ [ìˆ˜ì •] ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ edit.html íŒì—…ì°½ì„ ë„ìš°ëŠ” í•¨ìˆ˜
    window.editAssignment = function(docId) {
        const width = 750;
        const height = 850;
        const left = (window.screen.width / 2) - (width / 2);
        const top = (window.screen.height / 2) - (height / 2);
        
        // íŒì—…ì°½ ì‹¤í–‰
        window.open(
            `edit.html?id=${docId}`, 
            'ê°•ì˜ë‚´ìš©ìˆ˜ì •', 
            `width=${width}, height=${height}, left=${left}, top=${top}, scrollbars=yes, resizable=yes`
        );
    }

    // ì‚­ì œ í•¨ìˆ˜
    window.deleteAssignment = async function(docId, subject, teacher, client, date) {
        if (!confirm(`[í™•ì¸] ì•„ë˜ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n- êµìœ¡ì¼ì: ${date}\n- ê°•ì‚¬: ${teacher}\n- ê°•ì˜ì²˜: ${client}\n- ê°•ì¢Œëª…: ${subject}`)) return;
        try { await deleteDoc(doc(db, "assignments", docId)); } 
        catch (error) { alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    }

    // í•„í„°ë§ ê¸°ëŠ¥
    window.filterAssignments = function() {
        const teacherSel = document.getElementById('teacherFilter').value;
        const clientSel = document.getElementById('clientFilter').value;

        const filtered = allAssignments.filter(item => {
            const matchTeacher = (teacherSel === "all" || item.data.teacherName === teacherSel);
            const matchClient = (clientSel === "all" || item.data.client === clientSel);
            return matchTeacher && matchClient;
        });
        renderList(filtered);
    }

    // ëª©ë¡ ë Œë”ë§ í•¨ìˆ˜
    function renderList(dataList) {
        const listBody = document.getElementById('admin-list-body');
        let html = "";
        
        dataList.forEach((item) => {
            const data = item.data;
            const classHours = Number(data.classHours || 0);
            const hourlyRate = Number(data.hourlyRate || 0);
            const additionalCost = Number(data.additionalCost || 0);
            const commissionRate = Number(data.commissionRate || 0);

            const lectureFee = classHours * hourlyRate;
            const totalPay = lectureFee + additionalCost; 
            const serviceFee = data.serviceFee || 0;
            const isConfirmed = data.status === 'í™•ì¸ì™„ë£Œ';

            const dates = data.date ? data.date.split(', ') : [];
            const times = data.time ? data.time.split(', ') : [];
            let scheduleHtml = "";
            dates.forEach((d, i) => {
                const t = times[i] || '';
                scheduleHtml += `
                    <div class="schedule-item">
                        <span class="date-part">${d}</span>
                        <span class="time-part">${t}</span>
                    </div>`;
            });

            html += `
                <tr>
                    <td>${scheduleHtml}</td>
                    <td>
                        <span class="text-main">${data.teacherName}</span>
                        <span class="text-sub">${data.teacherEmail}</span>
                    </td>
                    <td>
                        <span class="text-main">${data.client}</span>
                        <span class="text-sub">${data.subject}</span>
                    </td>
                    <td>${data.role || 'ê°•ì‚¬'}</td>
                    <td>
                        <span class="text-main">${classHours}ì‹œê°„</span>
                        <span class="text-sub">${hourlyRate.toLocaleString()}ì›</span>
                    </td>
                    <td>
                        ${additionalCost > 0 ? `<span class="money-add">+${additionalCost.toLocaleString()} (ì¶”ê°€)</span>` : ''}
                        <span class="money-total">${totalPay.toLocaleString()}ì›</span>
                    </td>
                    <td>
                        <span class="text-main">${serviceFee.toLocaleString()}ì›</span>
                        <span class="text-sub">(${commissionRate}%)</span>
                    </td>
                    <td><span class="text-sub" style="font-size:12px;">${data.note || '-'}</span></td>
                    <td><span class="status-badge ${isConfirmed ? 'status-ok' : 'status-wait'}">${isConfirmed ? 'í™•ì¸ì™„ë£Œ' : 'í™•ì¸ëŒ€ê¸°'}</span></td>
                    <td>
                        <div class="chk-group">
                            <label><input type="checkbox" ${data.isPaidTeacher ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isPaidTeacher', this.checked)"> ê°•ì‚¬ë£Œ ì •ì‚°ì™„ë£Œ</label>
                            <label><input type="checkbox" ${data.isPaidService ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isPaidService', this.checked)"> ì„œë¹„ìŠ¤ì´ìš©ë£Œ í™•ì¸</label>
                        </div>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button class="btn-edit" onclick="editAssignment('${item.id}')">ìˆ˜ì •</button>
                            <button class="btn-delete" onclick="deleteAssignment('${item.id}', '${data.subject}', '${data.teacherName}', '${data.client}', '${data.date}')">ì‚­ì œ</button>
                        </div>
                    </td>
                </tr>
            `;
        });
        listBody.innerHTML = html || '<tr><td colspan="11" style="text-align:center; padding:30px;">ë‚´ì—­ ì—†ìŒ</td></tr>';
    }

    const q = query(collection(db, "assignments"), orderBy("createdAt", "desc"), limit(100));
    onSnapshot(q, (sn) => {
        allAssignments = [];
        const teachersSet = new Set();
        const clientsSet = new Set();

        sn.forEach((d) => {
            const data = d.data();
            allAssignments.push({ id: d.id, data: data });
            if(data.teacherName) teachersSet.add(data.teacherName);
            if(data.client) clientsSet.add(data.client);
        });

        let tHtml = `<option value="all">ì „ì²´ ê°•ì‚¬</option>`;
        teachersSet.forEach(t => tHtml += `<option value="${t}">${t}</option>`);
        document.getElementById('teacherFilter').innerHTML = tHtml;

        let cHtml = `<option value="all">ì „ì²´ ê°•ì˜ì²˜</option>`;
        clientsSet.forEach(c => cHtml += `<option value="${c}">${c}</option>`);
        document.getElementById('clientFilter').innerHTML = cHtml;

        filterAssignments();
    });
</script>
</body>
</html>