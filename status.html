<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ë“€ë©”ì´ì»¤ - ì „ì²´ ë°°ì • í˜„í™©</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f4f8; padding: 40px; margin: 0; padding-bottom: 80px; }
        .list-container { max-width: 1650px; margin: 0 auto; background: white; padding: 25px; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f3f5; padding-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .logo { font-size: 24px; font-weight: 800; color: #0056b3; cursor: pointer; text-decoration: none; }
        h2 { color: #1a1a1a; margin: 0; font-size: 20px; }
        .header-btn-group { display: flex; gap: 10px; }
        .btn-header { padding: 10px 18px; border-radius: 8px; font-size: 14px; font-weight: 600; text-decoration: none; color: white; transition: background 0.2s; border: none; cursor: pointer; }
        .btn-tab { background-color: #f1f3f5; color: #495057; border: 1px solid #e9ecef; }
        .btn-tab.active { background-color: #343a40; color: white; border-color: #343a40; }
        .btn-back { background-color: #6c757d; color: white; }
        .filter-bar { margin-bottom: 20px; display: flex; align-items: center; gap: 12px 20px; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; flex-wrap: wrap; }
        .filter-item { display: flex; align-items: center; gap: 8px; font-size: 13.5px; white-space: nowrap; }
        .filter-bar select { padding: 8px 10px; border-radius: 6px; border: 1px solid #ced4da; font-size: 13px; background-color: white; }
        .filter-bar input[type="date"] { padding: 7px 10px; border-radius: 6px; border: 1px solid #ced4da; font-size: 13px; font-family: inherit; }
        .date-search-group { margin-left: auto; display: flex; align-items: center; gap: 5px; }
        .btn-search { background-color: #0056b3; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-reset { background-color: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; }
        
        /* ğŸ”¥ í…Œì´ë¸” ì»¨í…Œì´ë„ˆ: ê¸°ëŠ¥ì€ ìœ ì§€í•˜ë˜ ìŠ¤í¬ë¡¤ë°”ëŠ” ìˆ¨ê¹€ */
        .table-responsive { 
            width: 100%; 
            overflow-x: auto; 
            border-bottom: 1px solid #eee; 
            position: relative;
            -ms-overflow-style: none; /* IE, Edge */
            scrollbar-width: none; /* Firefox */
        }
        .table-responsive::-webkit-scrollbar { display: none; /* Chrome, Safari */ }

        table { width: 100%; min-width: 1450px; border-collapse: collapse; table-layout: fixed; border-top: 2px solid #343a40; }
        th, td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: left; font-size: 13px; vertical-align: middle; }
        th { background-color: #fafafa; color: #495057; font-weight: 700; font-size: 12px; text-align: center; }
        
        .col-no { width: 45px; text-align: center; }
        .col-date { width: 140px; text-align: center; }
        .col-user { width: 170px; text-align: center; }
        .col-info { width: 220px; } 
        .col-pay { width: 110px; text-align: right; }
        .col-total { width: 130px; text-align: right; }
        .col-note { width: 150px; }
        .col-confirm { width: 75px; text-align: center; }
        .col-chk { width: 130px; }
        .col-manage { width: 120px; text-align: center; }

        .row-finished, .row-finished td { background-color: #fffde7 !important; }
        .row-class-finished, .row-class-finished td { background-color: #f3e5f5 !important; }

        .summary-bar { margin-top: 20px; background-color: #f8f9fa; border: 2px solid #343a40; border-radius: 12px; padding: 20px 30px; display: flex; justify-content: flex-end; align-items: center; gap: 40px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .sum-item { display: flex; align-items: center; gap: 10px; font-size: 15px; color: #333; }
        .sum-label { font-weight: 600; color: #555; }
        .sum-value { font-size: 18px; font-weight: 800; color: #343a40; }
        .sum-value.highlight { color: #d93025; font-size: 22px; }
        .sum-divider { width: 1px; height: 18px; background-color: #cbd5e1; }

        /* ğŸ”¥ í•˜ë‹¨ ê³ ì • ìŠ¤í¬ë¡¤ë°” ë””ìì¸ (PC ì „ìš©) */
        #fake-scroll-container {
            overflow-x: auto; overflow-y: hidden;
            position: fixed; bottom: 0; left: 0;
            width: 100%; z-index: 9999;
            background: #f8f9fa; border-top: 1px solid #dee2e6;
            height: 14px;
        }
        #fake-scroll-content { height: 1px; }

        .text-main { font-weight: 600; color: #333; }
        .text-sub { font-size: 11.5px; color: #666; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; }
        .status-wait { background: #fff3cd; color: #856404; }
        .status-ok { background: #d4edda; color: #155724; }
        .chk-group { display: flex; flex-direction: column; gap: 5px; font-size: 11.5px; }
        .chk-group label { display: flex; align-items: center; cursor: pointer; }
        .btn-group { display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; }
        .btn-group button { border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; padding: 6px 0; color: white; width: 48%; }
        .btn-full { width: 100% !important; margin-top: 2px; }
        .btn-finish { background-color: #555e67; }
        .btn-restore { background-color: #28a745; }
        .btn-edit { background-color: #0056b3; }
        .btn-delete { background-color: #ff4d4f; }

        /* ëª¨ë°”ì¼ì—ì„œëŠ” ê°€ì§œ ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
        @media (max-width: 768px) {
            #fake-scroll-container { display: none; }
            .table-responsive { scrollbar-width: auto; -ms-overflow-style: auto; }
            .table-responsive::-webkit-scrollbar { display: block; }
        }
    </style>
</head>
<body>

<div class="list-container">
    <div class="header">
        <div style="display:flex; align-items:center; gap:10px;">
            <a href="admin.html" class="logo">EDUMAKER ADMIN</a>
            <h2>ğŸ“Š ì „ì²´ ë°°ì • í˜„í™© (ì¢…í•©)</h2>
        </div>
        <div class="header-btn-group">
            <a href="status.html" class="btn-header btn-tab active">ì „ì²´ë³´ê¸°</a>
            <a href="status_general.html" class="btn-header btn-tab">ì¼ë°˜ê°•ì˜</a>
            <a href="status_find.html" class="btn-header btn-tab">ì°¾í•™ì»¨</a>
            <a href="status_dsac.html" class="btn-header btn-tab">ë””ì‹¹</a>
            <a href="admin.html" class="btn-header btn-back">ê°•ì˜ ë°°ì • í˜ì´ì§€</a>
        </div>
    </div>
    
    <div class="filter-bar">
        <div class="filter-item"><strong>ğŸ” ê°•ì‚¬ :</strong><select id="teacherFilter" onchange="filterAssignments()"><option value="all">ì „ì²´</option></select></div>
        <div class="filter-item"><strong>ğŸ« ê°•ì˜ì²˜ :</strong><select id="clientFilter" onchange="filterAssignments()"><option value="all">ì „ì²´</option></select></div>
        <div class="filter-item"><strong>ğŸ›ï¸ ì˜ë¢°ì²˜ :</strong><select id="requestClientFilter" onchange="filterAssignments()"><option value="all">ì „ì²´</option></select></div>
        <div class="filter-item"><strong>ğŸ–ï¸ ì—­í•  :</strong><select id="roleFilter" onchange="filterAssignments()"><option value="all">ì „ì²´</option></select></div>
        <div class="filter-item"><strong>ğŸ·ï¸ ì´ìš©ë£Œ :</strong><select id="servicePaidFilter" onchange="filterAssignments()"><option value="all">ì „ì²´</option><option value="paid">ì…ê¸ˆì™„ë£Œ</option><option value="unpaid">ë¯¸ì…ê¸ˆ</option></select></div>
        <div class="filter-item"><strong>âœ… í™•ì¸ :</strong><select id="confirmFilter" onchange="filterAssignments()"><option value="all">ì „ì²´</option><option value="confirmed">í™•ì¸ì™„ë£Œ</option><option value="pending">í™•ì¸ëŒ€ê¸°</option></select></div>
        <div class="date-search-group"><strong>ğŸ“… ê¸°ê°„ :</strong><input type="date" id="startDate"> ~ <input type="date" id="endDate"><button class="btn-search" onclick="filterAssignments()">ì¡°íšŒ</button><button class="btn-reset" onclick="resetFilters()">ì´ˆê¸°í™”</button></div>
    </div>

    <div class="table-responsive" id="main-table-container">
        <table>
            <thead>
                <tr>
                    <th class="col-no">No</th>
                    <th class="col-date">êµìœ¡ì¼ì/ì‹œê°„</th>
                    <th class="col-user">ì´ë¦„/ì´ë©”ì¼/ì˜ë¢°ì²˜</th>
                    <th class="col-info">ê°•ì˜ì²˜ / ê°•ì¢Œëª… / ì—­í• </th>
                    <th class="col-pay">ì‹œê°„ / ì‹œê¸‰ / ì¶”ê°€</th>
                    <th class="col-total">ì„œë¹„ìŠ¤ / ìˆ˜ìˆ˜ë£Œ / í•©ê³„</th>
                    <th class="col-note">ë¹„ê³ </th>
                    <th class="col-confirm">í™•ì¸</th>
                    <th class="col-chk">ì •ì‚° ì²˜ë¦¬</th>
                    <th class="col-manage">ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody id="admin-list-body">
                <tr><td colspan="10" style="text-align:center; padding:40px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>
    <div id="summary-container"></div>
</div>

<div id="fake-scroll-container">
    <div id="fake-scroll-content"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw", authDomain: "edumaker-teacher-d97ba.firebaseapp.com", projectId: "edumaker-teacher-d97ba", storageBucket: "edumaker-teacher-d97ba.firebasestorage.app", messagingSenderId: "532708143359", appId: "1:532708143359:web:89b9933da4c868127ddcca", measurementId: "G-JJ1TF77VBJ" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app);
    let allAssignments = [];

    // ğŸ”¥ ìŠ¤í¬ë¡¤ ë™ê¸°í™” ì´ˆê¸°í™”
    function initScrollSync() {
        const tableContainer = document.getElementById('main-table-container');
        const fakeContainer = document.getElementById('fake-scroll-container');
        const fakeContent = document.getElementById('fake-scroll-content');

        if(!tableContainer || !fakeContainer) return;

        fakeContent.style.width = tableContainer.scrollWidth + 'px';

        // ê°€ì§œ -> ì§„ì§œ ì—°ë™
        fakeContainer.onscroll = () => {
            if (tableContainer.scrollLeft !== fakeContainer.scrollLeft) {
                tableContainer.scrollLeft = fakeContainer.scrollLeft;
            }
        };

        // ì§„ì§œ -> ê°€ì§œ ì—°ë™
        tableContainer.onscroll = () => {
            if (fakeContainer.scrollLeft !== tableContainer.scrollLeft) {
                fakeContainer.scrollLeft = tableContainer.scrollLeft;
            }
        };
    }

    function getDayOfWeek(dateStr) {
        const week = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const day = new Date(dateStr).getDay();
        return isNaN(day) ? "" : `(${week[day]})`;
    }

    window.updatePayStatus = async function(docId, field, isChecked) {
        try { await updateDoc(doc(db, "assignments", docId), { [field]: isChecked }); } catch (error) { alert("ì‹¤íŒ¨"); }
    }
    window.toggleFinishStatus = async function(docId, currentStatus) {
        if(!confirm(currentStatus ? "ë‹¤ì‹œ í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ì™„ë£Œ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try { await updateDoc(doc(db, "assignments", docId), { isFinished: !currentStatus }); } catch (error) { alert("ë³€ê²½ ì‹¤íŒ¨"); }
    }
    window.editAssignment = function(docId) { window.open(`edit.html?id=${docId}`, 'edit', 'width=750,height=850,scrollbars=yes'); }
    window.deleteAssignment = async function(docId, subject, teacher) {
        if (!confirm(`[ì‚­ì œ í™•ì¸] ${teacher} ê°•ì‚¬ë‹˜ì˜ ${subject} ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        try { await deleteDoc(doc(db, "assignments", docId)); } catch (error) { alert("ì‚­ì œ ì‹¤íŒ¨"); }
    }

    function renderList(dataList) {
        const listBody = document.getElementById('admin-list-body');
        const summaryCon = document.getElementById('summary-container');
        let html = "";
        let sumServiceFee = 0; let sumGrandTotal = 0;

        dataList.forEach((item, index) => {
            const data = item.data;
            const isFinished = data.isFinished || false;
            const isClassFinished = data.isClassFinished || false; 
            const fee = Number(data.classHours || 0) * Number(data.hourlyRate || 0);
            const totalPay = fee + Number(data.additionalCost || 0);
            const serviceFee = Number(data.serviceFee || 0);
            const isConfirmed = data.status === 'í™•ì¸ì™„ë£Œ';
            sumServiceFee += serviceFee; sumGrandTotal += totalPay;

            let schHtml = "";
            (data.date || "").split(', ').forEach((d, i) => {
                schHtml += `<div style="margin-bottom:3px;"><b style="color:#333;">${d}${getDayOfWeek(d)}</b><br><span style="color:#0056b3; font-size:11px;">${(data.time||"").split(', ')[i]||''}</span></div>`;
            });

            const reqClient = (data.requestClient || "").trim();
            const lectureCheckHtml = (reqClient === "ì—ë“€ë©”ì´ì»¤")
                ? `<label><input type="checkbox" ${data.isPaidTeacher ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isPaidTeacher', this.checked)"> ê°•ì‚¬ë£Œì™„ë£Œ</label>`
                : `<span style="color:#aaa; font-size:11px; display:inline-block; padding:3px;">(ì˜ë¢°ì²˜ ì§€ê¸‰)</span>`;

            const serviceCheckHtml = Number(data.commissionRate || 0) > 0 
                ? `<label><input type="checkbox" ${data.isPaidService ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isPaidService', this.checked)"> ì´ìš©ë£Œí™•ì¸</label>` 
                : `<span style="color:#aaa; font-size:11px; display:inline-block; padding:3px;">(ì´ìš©ë£Œ ì—†ìŒ)</span>`;

            let rowClass = isFinished ? "row-finished" : (isClassFinished ? "row-class-finished" : "");

            html += `<tr class="${rowClass}">
                <td class="col-no">${item.virtualNo}</td>
                <td class="col-date">${schHtml}</td>
                <td class="col-user"><span class="text-main">${data.teacherName}</span><br><span class="text-sub">${data.teacherEmail}</span><br><span class="text-client">${data.requestClient || '-'}</span></td>
                <td class="col-info"><span class="text-line"><b>${data.client}</b></span><span class="text-line">${data.subject}</span><span class="text-line text-sub">ì—­í• : ${data.role || 'ê°•ì‚¬'}</span></td>
                <td class="col-pay"><span class="text-line">${data.classHours}ì‹œê°„</span><span class="text-line text-sub">${Number(data.hourlyRate).toLocaleString()}ì›</span></td>
                <td class="col-total"><span class="text-line text-blue">${serviceFee.toLocaleString()}ì›</span><span class="text-line text-red">${totalPay.toLocaleString()}ì›</span></td>
                <td class="col-note"><div class="note-content">${(data.note || '-').replace(/\n/g, '<br>')}</div></td>
                <td class="col-confirm"><span class="status-badge ${isConfirmed ? 'status-ok' : 'status-wait'}">${isConfirmed ? 'ì™„ë£Œ' : 'ëŒ€ê¸°'}</span></td>
                <td class="col-chk"><div class="chk-group">${lectureCheckHtml}${serviceCheckHtml}<label><input type="checkbox" ${data.isClassFinished ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isClassFinished', this.checked)"> ìˆ˜ì—…ì¢…ë£Œ</label></div></td>
                <td class="col-manage"><div class="btn-group"><button class="btn-finish" onclick="toggleFinishStatus('${item.id}', ${isFinished})">${isFinished ? 'ë³µêµ¬' : 'ì™„ë£Œ'}</button><button class="btn-edit" onclick="editAssignment('${item.id}')">ìˆ˜ì •</button><button class="btn-delete btn-full" onclick="deleteAssignment('${item.id}', '${data.subject}', '${data.teacherName}')">ì‚­ì œ</button></div></td>
            </tr>`;
        });
        listBody.innerHTML = html || '<tr><td colspan="10" style="text-align:center; padding:40px;">ë°°ì • ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        summaryCon.innerHTML = `<div class="summary-bar"><div class="sum-item"><span class="sum-label">ì´ ë°°ì •ê±´ìˆ˜</span><span class="sum-value">${dataList.length}ê±´</span></div><div class="sum-divider"></div><div class="sum-item"><span class="sum-label">ì„œë¹„ìŠ¤ ì´ìš©ë£Œ</span><span class="sum-value">${sumServiceFee.toLocaleString()}ì›</span></div><div class="sum-divider"></div><div class="sum-item"><span class="sum-label">ì´ ë§¤ì¶œ(ê°•ì‚¬ë£Œí¬í•¨)</span><span class="sum-value highlight">${sumGrandTotal.toLocaleString()}ì›</span></div></div>`;
        
        // ë°ì´í„° ì¶œë ¥ í›„ ë™ê¸°í™” ì¬ì„¤ì •
        setTimeout(initScrollSync, 100);
    }

    onSnapshot(query(collection(db, "assignments"), orderBy("createdAt", "desc"), limit(500)), (sn) => {
        let rawData = sn.docs.map(d => ({ id: d.id, data: d.data() }));
        rawData.sort((a, b) => {
            const dateA = (a.data.date || "").split(', ')[0] || "0000-00-00";
            const dateB = (b.data.date || "").split(', ')[0] || "0000-00-00";
            return dateB.localeCompare(dateA);
        });
        allAssignments = rawData.map((item, index) => ({ ...item, virtualNo: rawData.length - index }));
        
        const tSet = new Set(); const cSet = new Set(); const rSet = new Set(); const roleSet = new Set();
        allAssignments.forEach(i => { 
            if(i.data.teacherName) tSet.add(i.data.teacherName); 
            if(i.data.client) cSet.add(i.data.client);
            if(i.data.requestClient) rSet.add(i.data.requestClient); 
            if(i.data.role) roleSet.add(i.data.role);
        });

        document.getElementById('teacherFilter').innerHTML = `<option value="all">ì „ì²´</option>` + Array.from(tSet).sort().map(t => `<option value="${t}">${t}</option>`).join('');
        document.getElementById('clientFilter').innerHTML = `<option value="all">ì „ì²´</option>` + Array.from(cSet).sort().map(c => `<option value="${c}">${c}</option>`).join('');
        document.getElementById('requestClientFilter').innerHTML = `<option value="all">ì „ì²´</option>` + Array.from(rSet).sort().map(r => `<option value="${r}">${r}</option>`).join('');
        document.getElementById('roleFilter').innerHTML = `<option value="all">ì „ì²´</option>` + Array.from(roleSet).sort().map(role => `<option value="${role}">${role}</option>`).join('');
        
        filterAssignments(); 
    });

    window.filterAssignments = () => {
        const t = document.getElementById('teacherFilter').value; 
        const c = document.getElementById('clientFilter').value;
        const r = document.getElementById('requestClientFilter').value;
        const role = document.getElementById('roleFilter').value;
        const s = document.getElementById('confirmFilter').value; 
        const servicePaid = document.getElementById('servicePaidFilter').value;
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;

        const filtered = allAssignments.filter(item => {
            const data = item.data;
            if (t !== "all" && data.teacherName !== t) return false;
            if (c !== "all" && data.client !== c) return false;
            if (r !== "all" && data.requestClient !== r) return false;
            if (role !== "all" && data.role !== role) return false;
            if (s === "confirmed" && data.status !== 'í™•ì¸ì™„ë£Œ') return false;
            if (s === "pending" && data.status === 'í™•ì¸ì™„ë£Œ') return false;
            if (servicePaid === "paid" && !data.isPaidService) return false;
            if (servicePaid === "unpaid" && data.isPaidService) return false;
            if (start && end) {
                const dates = (data.date || "").split(', ');
                if (!dates.some(d => d >= start && d <= end)) return false;
            }
            return true;
        });
        renderList(filtered);
    }

    window.resetFilters = () => { 
        document.querySelectorAll('.filter-bar select').forEach(s => s.value = 'all');
        document.querySelectorAll('.filter-bar input').forEach(i => i.value = '');
        filterAssignments(); 
    }

    window.addEventListener('resize', initScrollSync);
</script>
</body>
</html>