<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—ë“€ë©”ì´ì»¤ - ë°°ì • í˜„í™© ë° ì •ì‚° ê´€ë¦¬</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f4f8; padding: 40px; margin: 0; }
        .list-container { max-width: 1450px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); }
        
        /* ìƒë‹¨ í—¤ë” ì˜ì—­ */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f3f5; padding-bottom: 20px; }
        .logo { font-size: 24px; font-weight: 800; color: #0056b3; cursor: pointer; text-decoration: none; }
        h2 { color: #1a1a1a; margin: 0; font-size: 22px; }
        
        /* í•„í„° ë°” */
        .filter-bar { margin-bottom: 25px; display: flex; align-items: center; gap: 20px; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; }
        .filter-item { display: flex; align-items: center; gap: 8px; }
        .filter-bar select { padding: 10px 15px; border-radius: 6px; border: 1px solid #ced4da; font-size: 14px; background-color: white; }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border-bottom: 1px solid #eee; padding: 12px; text-align: left; font-size: 13px; vertical-align: middle; }
        th { background-color: #fcfcfc; color: #495057; font-weight: 700; }
        
        th:nth-child(1) { width: 90px; }  /* êµìœ¡ì¼ì */
        th:nth-child(2) { width: 110px; } /* ì´ë¦„(ì—­í• ) */
        th:nth-child(3) { width: 130px; } /* ê°•ì˜ì²˜ */
        th:nth-child(4) { width: 180px; } /* ê°•ì¢Œëª… */
        th:nth-child(7) { width: 100px; } /* ê°•ì‚¬ë£Œ(ì´) */
        th:nth-child(8) { width: 100px; } /* ìˆ˜ìˆ˜ë£Œ */
        
        .wrap-text { white-space: normal; word-break: break-all; line-height: 1.4; color: #444; }
        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .status-wait { background: #fff3cd; color: #856404; }
        .status-ok { background: #d4edda; color: #155724; }
        
        .chk-group { display: flex; flex-direction: column; gap: 4px; font-size: 11px; }
        .btn-edit { padding: 5px 10px; background-color: #0056b3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 3px; }
        .btn-delete { padding: 5px 10px; background-color: #ff4d4f; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }

        .btn-back {
            background-color: #0056b3; color: white; text-decoration: none; padding: 10px 22px;
            border-radius: 8px; font-size: 14px; font-weight: 600; transition: background 0.2s;
        }
        .btn-back:hover { background-color: #004494; }

        .fee-amount { color: #d93025; font-weight: 600; display: block; }
        .fee-rate { color: #888; font-size: 11px; display: block; margin-top: 2px; }
    </style>
</head>
<body>

<div class="list-container">
    <div class="header">
        <a href="admin.html" class="logo">EDUMAKER ADMIN</a>
        <h2>ğŸ“‹ ë°°ì • í˜„í™© ë° ì •ì‚° ê´€ë¦¬</h2>
        <a href="admin.html" class="btn-back">ê°•ì˜ ë°°ì • í˜ì´ì§€ë¡œ</a>
    </div>
    
    <div class="filter-bar">
        <div class="filter-item">
            <strong>ğŸ” ê°•ì‚¬ í•„í„° :</strong>
            <select id="teacherFilter" onchange="filterAssignments()">
                <option value="all">ì „ì²´ ê°•ì‚¬</option>
            </select>
        </div>
        <div class="filter-item">
            <strong>ğŸ« ê°•ì˜ì²˜ í•„í„° :</strong>
            <select id="clientFilter" onchange="filterAssignments()">
                <option value="all">ì „ì²´ ê°•ì˜ì²˜</option>
            </select>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>êµìœ¡ì¼ì</th>
                <th>ì´ë¦„(ì—­í• )</th>
                <th>ê°•ì˜ì²˜</th>
                <th>ê°•ì¢Œëª…</th>
                <th>ê°•ì˜ì‹œê°„</th>
                <th>ì‹œê°„ë‹¹ ê°•ì‚¬ë£Œ</th>
                <th>ê°•ì‚¬ë£Œ(ì´)</th>
                <th>ìˆ˜ìˆ˜ë£Œ</th>
                <th>ë¹„ê³ </th>
                <th>ê°•ì‚¬í™•ì¸</th>
                <th>ìƒì„¸ ì •ì‚° ì²˜ë¦¬</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody id="admin-list-body">
            <tr><td colspan="12" style="text-align:center; padding:40px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
        </tbody>
    </table>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // Firebase ì„¤ì •
    const firebaseConfig = {
        apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw",
        authDomain: "edumaker-teacher-d97ba.firebaseapp.com",
        projectId: "edumaker-teacher-d97ba",
        storageBucket: "edumaker-teacher-d97ba.firebasestorage.app",
        messagingSenderId: "532708143359",
        appId: "1:532708143359:web:89b9933da4c868127ddcca",
        measurementId: "G-JJ1TF77VBJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allAssignments = [];

    /* [DB í•„ë“œ í˜¸ì¶œ ì•ˆë‚´ - 'assignments' ì»¬ë ‰ì…˜] 
       1. date           : êµìœ¡ ì¼ì
       2. teacherName    : ê°•ì‚¬ ì„±í•¨
       3. client         : ê°•ì˜ì²˜ (í•™êµ/ê¸°ê´€)
       4. subject        : ê°•ì¢Œëª…
       5. role           : ì—­í•  (ì£¼ê°•ì‚¬ ë“±)
       6. classHours     : ì´ ê°•ì˜ ì‹œê°„
       7. hourlyRate    : ì‹œê°„ë‹¹ ê°•ì‚¬ë£Œ
       8. serviceFee     : ì„œë¹„ìŠ¤ ì´ìš©ë£Œ
       9. commissionRate : ìˆ˜ìˆ˜ë£Œìœ¨
       10. status        : í™•ì¸ ìƒíƒœ
       11. isPaidTeacher : ê°•ì‚¬ ì •ì‚° ì—¬ë¶€
       12. isPaidService : ì„œë¹„ìŠ¤ì´ìš©ë£Œ ì •ì‚° ì—¬ë¶€
    */

    window.updatePayStatus = async function(docId, field, isChecked) {
        try {
            await updateDoc(doc(db, "assignments", docId), { [field]: isChecked });
        } catch (error) {
            alert("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
        }
    }

    window.editAssignment = async function(docId) {
        const item = allAssignments.find(a => a.id === docId);
        if(!item) return;
        const data = item.data;

        const newDate = prompt("êµìœ¡ ì¼ì (YYYY-MM-DD):", data.date) || data.date;
        const newTime = prompt("ìƒì„¸ ì‹œê°„:", data.time) || data.time;
        const newRole = prompt("ì—­í• :", data.role || 'ì£¼ê°•ì‚¬') || data.role;
        const newHours = prompt("ê°•ì˜ ì‹œê°„ (ìˆ«ì):", data.classHours) || data.classHours;
        const newRate = prompt("ì‹œê°„ë‹¹ ê°•ì‚¬ë£Œ (ìˆ«ì):", data.hourlyRate) || data.hourlyRate;
        const newComm = prompt("ì„œë¹„ìŠ¤ì´ìš©ë£Œìœ¨ (%):", data.commissionRate || 10) || (data.commissionRate || 10);
        const newNote = prompt("ë¹„ê³ :", data.note || "") || (data.note || "");

        try {
            const h = Number(newHours);
            const r = Number(newRate);
            const c = Number(newComm);
            const fee = Math.floor((h * r) * (c / 100));

            await updateDoc(doc(db, "assignments", docId), {
                date: newDate, time: newTime, role: newRole, classHours: h,
                hourlyRate: r, commissionRate: c, serviceFee: fee, note: newNote, status: "ë°°ì •ì™„ë£Œ"
            });
            alert("ìˆ˜ì • ì™„ë£Œ");
        } catch (error) {
            alert("ìˆ˜ì • ì‹¤íŒ¨");
        }
    }

    // ğŸ”¥ ì‚­ì œ í•¨ìˆ˜: ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸ì°½ì— í‘œì‹œ
    window.deleteAssignment = async function(docId, subject, teacher, client, date) {
        if (!confirm(`[í™•ì¸] ì•„ë˜ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n- êµìœ¡ì¼ì: ${date}\n- ê°•ì‚¬: ${teacher}\n- ê°•ì˜ì²˜: ${client}\n- ê°•ì¢Œëª…: ${subject}`)) return;
        try {
            await deleteDoc(doc(db, "assignments", docId));
        } catch (error) {
            alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    window.filterAssignments = function() {
        const teacherSel = document.getElementById('teacherFilter').value;
        const clientSel = document.getElementById('clientFilter').value;

        const filtered = allAssignments.filter(item => {
            const matchTeacher = (teacherSel === "all" || item.data.teacherName === teacherSel);
            const matchClient = (clientSel === "all" || item.data.client === clientSel);
            return matchTeacher && matchClient;
        });

        renderList(filtered);
    }

    function renderList(dataList) {
        const listBody = document.getElementById('admin-list-body');
        let html = "";
        
        dataList.forEach((item) => {
            const data = item.data;
            const totalPay = (data.classHours || 0) * (data.hourlyRate || 0);
            const isConfirmed = data.status === 'í™•ì¸ì™„ë£Œ';

            html += `
                <tr>
                    <td>${data.date}</td>
                    <td><b>${data.teacherName}</b><br><small>(${data.role || 'ê°•ì‚¬'})</small></td>
                    <td>${data.client}</td>
                    <td class="wrap-text">${data.subject}</td>
                    <td>${data.classHours || 0}ì‹œê°„</td>
                    <td>${(data.hourlyRate || 0).toLocaleString()}ì›</td>
                    <td style="font-weight:bold;">${totalPay.toLocaleString()}ì›</td>
                    <td>
                        <span class="fee-amount">-${(data.serviceFee || 0).toLocaleString()}ì›</span>
                        <span class="fee-rate">(${data.commissionRate || 0}%)</span>
                    </td>
                    <td class="wrap-text">${data.note || '-'}</td>
                    <td><span class="status-badge ${isConfirmed ? 'status-ok' : 'status-wait'}">${isConfirmed ? 'í™•ì¸ì™„ë£Œ' : 'í™•ì¸ëŒ€ê¸°'}</span></td>
                    <td>
                        <div class="chk-group">
                            <label><input type="checkbox" ${data.isPaidTeacher ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isPaidTeacher', this.checked)"> ê°•ì‚¬ë£Œ ì •ì‚°ì™„ë£Œ</label>
                            <label><input type="checkbox" ${data.isPaidService ? 'checked' : ''} onchange="updatePayStatus('${item.id}', 'isPaidService', this.checked)"> ì„œë¹„ìŠ¤ì´ìš©ë£Œ í™•ì¸</label>
                        </div>
                    </td>
                    <td>
                        <button class="btn-edit" onclick="editAssignment('${item.id}')">ìˆ˜ì •</button>
                        <button class="btn-delete" onclick="deleteAssignment('${item.id}', '${data.subject}', '${data.teacherName}', '${data.client}', '${data.date}')">ì‚­ì œ</button>
                    </td>
                </tr>
            `;
        });
        listBody.innerHTML = html || '<tr><td colspan="12" style="text-align:center;">ë‚´ì—­ ì—†ìŒ</td></tr>';
    }

    const q = query(collection(db, "assignments"), orderBy("createdAt", "desc"), limit(100));
    onSnapshot(q, (sn) => {
        allAssignments = [];
        const teachersSet = new Set();
        const clientsSet = new Set();

        sn.forEach((d) => {
            const data = d.data();
            allAssignments.push({ id: d.id, data: data });
            if(data.teacherName) teachersSet.add(data.teacherName);
            if(data.client) clientsSet.add(data.client);
        });

        let tHtml = `<option value="all">ì „ì²´ ê°•ì‚¬</option>`;
        teachersSet.forEach(t => tHtml += `<option value="${t}">${t}</option>`);
        document.getElementById('teacherFilter').innerHTML = tHtml;

        let cHtml = `<option value="all">ì „ì²´ ê°•ì˜ì²˜</option>`;
        clientsSet.forEach(c => cHtml += `<option value="${c}">${c}</option>`);
        document.getElementById('clientFilter').innerHTML = cHtml;

        filterAssignments();
    });
</script>
</body>
</html>