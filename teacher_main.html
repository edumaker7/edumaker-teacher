<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ë“€ë©”ì´ì»¤ - ê°•ì‚¬ ì „ìš©</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f4f8; margin: 0; padding: 0; }
        .header { background-color: #0056b3; color: white; padding: 20px; text-align: center; }
        .container { max-width: 900px; margin: 20px auto; padding: 0 20px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .welcome-msg { font-size: 16px; color: #333; margin: 0; font-weight: 600; }
        .view-toggle { display: flex; background: #e9ecef; border-radius: 8px; padding: 4px; }
        .toggle-btn { border: none; background: none; padding: 8px 12px; font-size: 13px; cursor: pointer; border-radius: 6px; font-weight: bold; color: #666; }
        .toggle-btn.active { background: #fff; color: #0056b3; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .assignment-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-top: 5px solid #0056b3; position: relative; }
        .card h3 { margin-top: 0; color: #0056b3; font-size: 20px; border-bottom: 1px solid #eee; padding-bottom: 12px; display: flex; align-items: center; }
        .card h3::before { content: 'ğŸ« '; }
        
        /* ğŸ”¥ ì—…ë°ì´íŠ¸ ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .upd-badge { background: #d93025; color: white; font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
        
        .card p { margin: 8px 0; font-size: 15px; color: #555; display: flex; align-items: flex-start; }
        .card b { color: #333; width: 130px; flex-shrink: 0; } 
        .card span { flex: 1; word-break: keep-all; }

        /* ğŸ”¥ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ (ì—…ë°ì´íŠ¸ëœ í•­ëª© ê°•ì¡°) */
        .highlight { color: #0056b3 !important; font-weight: bold; background: #e7f1ff; border-radius: 4px; padding: 2px 4px; }

        .schedule-list { background-color: #f8f9fa; padding: 10px; border-radius: 8px; margin: 5px 0 15px 0; font-size: 14px; }
        .schedule-item { margin-bottom: 4px; display: flex; gap: 10px; }
        .sc-date { font-weight: bold; color: #0056b3; }
        .divider { border-top: 1px dashed #ddd; margin: 15px 0; }
        .total-pay { color: #d93025; font-weight: bold; font-size: 1.1em; }
        .note-box { background-color: #fef9e7; border-left: 4px solid #f1c40f; padding: 12px; margin-top: 15px; font-size: 14px; color: #666; line-height: 1.5; }
        .pay-status-row { display: flex; gap: 8px; margin-top: 15px; }
        .status-box { flex: 1; padding: 10px 5px; text-align: center; border-radius: 8px; font-weight: bold; font-size: 11px; }
        .status-waiting { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-complete { background-color: #e9ecef; color: #6c757d; border: 1px solid #dee2e6; }
        .check-btn { width: 100%; padding: 14px; margin-top: 15px; background-color: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .confirmed-msg { display: block; margin-top: 15px; padding: 14px; text-align: center; background-color: #f8f9fa; color: #adb5bd; border-radius: 8px; font-weight: bold; font-size: 14px; }
        .logout-btn { background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; }

        /* ë¦¬ìŠ¤íŠ¸í˜• ìŠ¤íƒ€ì¼ */
        .list-container { display: flex; flex-direction: column; gap: 10px; }
        .list-item { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid #ccc; }
        .list-header { padding: 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .lh-info { flex: 1; }
        .lh-date { font-size: 12px; color: #888; font-weight: bold; }
        .lh-title { font-size: 16px; font-weight: bold; color: #333; }
        .lh-status { font-size: 12px; padding: 4px 8px; border-radius: 12px; margin-left: 10px; }
        .st-wait { background: #fff3cd; color: #856404; }
        .st-ok { background: #d4edda; color: #155724; }
        .list-body { display: none; padding: 0 15px 15px 15px; border-top: 1px solid #eee; background-color: #fafafa; }
    </style>
</head>
<body>
    <div class="header"><h1>EDUMAKER ê°•ì‚¬ ì „ìš©</h1></div>
    <div class="container">
        <div class="top-bar">
            <div id="welcome-text" class="welcome-msg">ì •ë³´ ë¡œë”© ì¤‘...</div>
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="view-toggle">
                    <button class="toggle-btn active" id="btn-card" onclick="changeView('card')">ğŸ—‚ï¸ ì¹´ë“œí˜•</button>
                    <button class="toggle-btn" id="btn-list" onclick="changeView('list')">â˜° ë¦¬ìŠ¤íŠ¸í˜•</button>
                </div>
                <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
        <div id="card-view-container" class="assignment-grid"></div>
        <div id="list-view-container" class="list-container" style="display:none;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw",
            authDomain: "edumaker-teacher-d97ba.firebaseapp.com",
            projectId: "edumaker-teacher-d97ba",
            storageBucket: "edumaker-teacher-d97ba.firebasestorage.app",
            messagingSenderId: "532708143359",
            appId: "1:532708143359:web:89b9933da4c868127ddcca",
            measurementId: "G-JJ1TF77VBJ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let assignmentsData = [];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const qUser = query(collection(db, "users"), where("email", "==", user.email));
                const snap = await getDocs(qUser);
                let dName = snap.empty ? "ê°•ì‚¬" : snap.docs[0].data().name;
                document.getElementById('welcome-text').innerHTML = `âœ¨ <b>${dName}(${user.email})</b> ê°•ì‚¬ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
                listenAssignments(user.email);
            } else location.href = "index.html";
        });

        function listenAssignments(email) {
            const q = query(collection(db, "assignments"), where("teacherEmail", "==", email), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                assignmentsData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderAssignments();
            });
        }

        window.changeView = (mode) => {
            document.getElementById('card-view-container').style.display = mode === 'card' ? 'grid' : 'none';
            document.getElementById('list-view-container').style.display = mode === 'list' ? 'flex' : 'none';
            document.getElementById('btn-card').className = `toggle-btn ${mode==='card'?'active':''}`;
            document.getElementById('btn-list').className = `toggle-btn ${mode==='list'?'active':''}`;
        }

        function renderAssignments() {
            const cardCon = document.getElementById('card-view-container');
            const listCon = document.getElementById('list-view-container');
            let cardHtml = ""; let listHtml = "";

            assignmentsData.forEach(data => {
                const lectureFee = Number(data.classHours) * Number(data.hourlyRate);
                const totalGrossPay = lectureFee + Number(data.additionalCost || 0);
                const serviceFee = Math.floor(lectureFee * (Number(data.commissionRate) / 100));
                
                // ğŸ”¥ ì—…ë°ì´íŠ¸ ê°•ì¡° ë¡œì§
                const isConfirmed = data.status === 'í™•ì¸ì™„ë£Œ';
                const showUpd = data.isUpdated && !isConfirmed; // ìˆ˜ì •ë˜ì—ˆê³  ì•„ì§ í™•ì¸ ì•ˆ í•œ ê²½ìš°
                const updBadge = showUpd ? `<span class="upd-badge">ë‚´ìš©ë³€ê²½</span>` : "";
                const hlClass = showUpd ? "highlight" : "";

                const dates = data.date ? data.date.split(', ') : [];
                const times = data.time ? data.time.split(', ') : [];
                let schHtml = `<div class="schedule-list">`;
                dates.forEach((d, i) => { schHtml += `<div class="schedule-item"><span class="sc-date">ğŸ“… ${d}</span><span class="sc-time">â° ${times[i]}</span></div>`; });
                schHtml += `</div>`;

                const commonHtml = `
                    <p><b>ğŸ“ ê°•ì˜ ì£¼ì†Œ</b> <span class="${hlClass}"><a href="https://map.naver.com/v5/search/${encodeURIComponent(data.address)}" target="_blank" class="map-link">${data.address} ğŸ”—</a></span></p>
                    <p><b>ğŸ« êµìœ¡ ì¥ì†Œ</b> <span class="${hlClass}">${data.classRoom || 'ë¯¸ì •'}</span></p>
                    <p><b>ğŸ–ï¸ ë°°ì •ì—­í• </b> <span>${data.role}</span></p>
                    <div style="margin-top: 10px; font-weight: bold; color: #555;">ğŸ“† êµìœ¡ ì¼ì • ${showUpd ? '(ì‹œê°„ë³€ê²½ í™•ì¸ìš”ë§)' : ''}</div>
                    <div class="${hlClass}">${schHtml}</div>
                    <div class="divider"></div>
                    <p><b>â³ ì´ ê°•ì˜ì‹œê°„</b> <span>${data.classHours}ì‹œê°„</span></p>
                    <p><b>ğŸ’° ì‹œê°„ë‹¹ ê°•ì‚¬ë£Œ</b> <span>${data.hourlyRate.toLocaleString()}ì›</span></p>
                    <p><b>â• ì¶”ê°€ë¹„ìš©</b> <span>${(data.additionalCost || 0).toLocaleString()}ì›</span></p>
                    <p class="total-pay"><b>ğŸ’µ ì´ ê°•ì‚¬ë£Œ</b> <span class="${hlClass}">${totalGrossPay.toLocaleString()}ì›</span></p>
                    <p><b>ğŸ·ï¸ ì„œë¹„ìŠ¤ ì´ìš©ë£Œ</b> <span>${serviceFee.toLocaleString()}ì› (${data.commissionRate}%)</span></p>
                    <div class="pay-status-row">
                        <div class="status-box ${data.isPaidTeacher?'status-complete':'status-waiting'}">${data.isPaidTeacher?'âœ… ê°•ì‚¬ë£Œ ì™„ë£Œ':'âŒ› ê°•ì‚¬ë£Œ ëŒ€ê¸°'}</div>
                        <div class="status-box ${data.isPaidService?'status-complete':'status-waiting'}">${data.isPaidService?'âœ… ì„œë¹„ìŠ¤ì´ìš©ë£Œ í™•ì¸':'âŒ› ì„œë¹„ìŠ¤ì´ìš©ë£Œ ëŒ€ê¸°'}</div>
                    </div>
                    ${isConfirmed ? `<span class="confirmed-msg">ğŸ‘ í™•ì¸ ì™„ë£Œë¨</span>` 
                    : `<button class="check-btn" onclick="confirmAssignment('${data.id}')">ë³€ê²½ëœ ê°•ì˜ë‚´ìš© í™•ì¸í•˜ê¸°</button>`}`;

                cardHtml += `<div class="card"><h3>${data.client} ${updBadge}</h3><p><b>ğŸ“š ê°•ì¢Œëª…</b> <span>${data.subject}</span></p>${commonHtml}</div>`;
                listHtml += `<div class="list-item" style="border-left-color:${isConfirmed?'#28a745':'#ffc107'}">
                    <div class="list-header" onclick="toggleDetail('${data.id}')"><div class="lh-info"><div class="lh-date">${dates[0]}</div><div class="lh-title">${data.client} ${updBadge}</div></div><span class="lh-status ${isConfirmed?'st-ok':'st-wait'}">${isConfirmed?'í™•ì¸ì™„ë£Œ':'í™•ì¸ëŒ€ê¸°'}</span></div>
                    <div class="list-body" id="detail-${data.id}">${commonHtml}</div></div>`;
            });
            cardCon.innerHTML = cardHtml || '<div style="text-align:center; padding:40px;">ë‚´ì—­ ì—†ìŒ</div>';
            listCon.innerHTML = listHtml;
        }

        window.toggleDetail = (id) => { const el = document.getElementById(`detail-${id}`); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
        
        window.confirmAssignment = async (docId) => {
            if(!confirm("ë³€ê²½ëœ ê°•ì˜ ë°°ì • ë‚´ìš©ì„ í™•ì¸í•˜ì…¨ìŠµë‹ˆê¹Œ?")) return;
            // ğŸ”¥ í™•ì¸ì„ ëˆ„ë¥´ë©´ isUpdatedë¥¼ falseë¡œ ëŒë ¤ì„œ ê°•ì¡° íš¨ê³¼ ì œê±°
            await updateDoc(doc(db, "assignments", docId), { status: "í™•ì¸ì™„ë£Œ", isUpdated: false });
        }
        window.handleLogout = () => signOut(auth).then(() => { location.href = "index.html"; });
    </script>
</body>
</html>