<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ë“€ë©”ì´ì»¤ - ê°•ì‚¬ ì „ìš©</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f4f8; margin: 0; padding: 0; }
        .header { background-color: #0056b3; color: white; padding: 20px; text-align: center; }
        .container { max-width: 900px; margin: 20px auto; padding: 0 20px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-top: 5px solid #0056b3; margin-bottom:20px; position:relative; }
        .upd-badge { background: #d93025; color: white; font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
        
        /* ğŸ”¥ ì§„ì§œ ë³€ê²½ëœ í•­ëª©ë§Œ ì¹ í•´ì¤„ ìŠ¤íƒ€ì¼ */
        .highlight { background: #fff3cd !important; border: 1px solid #ffeeba !important; padding: 2px 5px; border-radius: 4px; font-weight: bold; color: #856404 !important; }

        .card h3 { margin-top: 0; color: #0056b3; font-size: 20px; border-bottom: 1px solid #eee; padding-bottom: 12px; display: flex; align-items: center; }
        .card p { margin: 8px 0; font-size: 15px; color: #555; display: flex; align-items: flex-start; }
        .card b { color: #333; width: 130px; flex-shrink: 0; } 
        .schedule-list { background-color: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 14px; margin-top:5px; }
        .total-pay { color: #d93025; font-weight: bold; font-size: 1.1em; }
        .status-box { flex: 1; padding: 10px 5px; text-align: center; border-radius: 8px; font-weight: bold; font-size: 11px; }
        .status-waiting { background-color: #d4edda; color: #155724; }
        .status-complete { background-color: #e9ecef; color: #6c757d; }
        .check-btn { width: 100%; padding: 14px; margin-top: 15px; background-color: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .confirmed-msg { display: block; margin-top: 15px; padding: 14px; text-align: center; background-color: #f8f9fa; color: #adb5bd; border-radius: 8px; font-weight: bold; }
        .view-toggle { display: flex; background: #e9ecef; border-radius: 8px; padding: 4px; }
        .toggle-btn { border: none; background: none; padding: 8px 12px; font-size: 13px; cursor: pointer; border-radius: 6px; font-weight: bold; color: #666; }
        .toggle-btn.active { background: #fff; color: #0056b3; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="header"><h1>EDUMAKER ê°•ì‚¬ ì „ìš©</h1></div>
    <div class="container">
        <div class="top-bar">
            <div id="welcome-text" style="font-weight:bold;">ë¡œë”©ì¤‘...</div>
            <div class="view-toggle">
                <button class="toggle-btn active" id="btn-card" onclick="changeView('card')">ì¹´ë“œí˜•</button>
                <button class="toggle-btn" id="btn-list" onclick="changeView('list')">ë¦¬ìŠ¤íŠ¸í˜•</button>
            </div>
        </div>
        <div id="card-view-container"></div>
        <div id="list-view-container" style="display:none;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, doc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw",
            authDomain: "edumaker-teacher-d97ba.firebaseapp.com",
            projectId: "edumaker-teacher-d97ba",
            storageBucket: "edumaker-teacher-d97ba.firebasestorage.app",
            messagingSenderId: "532708143359",
            appId: "1:532708143359:web:89b9933da4c868127ddcca",
            measurementId: "G-JJ1TF77VBJ"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const uSnap = await getDocs(query(collection(db, "users"), where("email", "==", user.email)));
                document.getElementById('welcome-text').innerText = `âœ¨ ${uSnap.docs[0].data().name} ê°•ì‚¬ë‹˜`;
                listenAssignments(user.email);
            } else location.href = "index.html";
        });

        function listenAssignments(email) {
            onSnapshot(query(collection(db, "assignments"), where("teacherEmail", "==", email), orderBy("createdAt", "desc")), (snap) => {
                let cardHtml = "";
                snap.forEach(d => {
                    const data = d.data();
                    const isConfirmed = data.status === 'í™•ì¸ì™„ë£Œ';
                    const showUpd = data.isUpdated && !isConfirmed;
                    
                    // ğŸ”¥ ê°œë³„ í•˜ì´ë¼ì´íŠ¸ í´ë˜ìŠ¤ ê²°ì •
                    const hlAddr = showUpd && data.changed_address ? "highlight" : "";
                    const hlRoom = showUpd && data.changed_classRoom ? "highlight" : "";
                    const hlSch = showUpd && data.changed_schedule ? "highlight" : "";
                    const hlMoney = showUpd && data.changed_money ? "highlight" : "";

                    const lectureFee = Number(data.classHours) * Number(data.hourlyRate);
                    const totalPay = lectureFee + Number(data.additionalCost || 0);

                    cardHtml += `
                        <div class="card">
                            <h3>${data.client} ${showUpd ? '<span class="upd-badge">ë‚´ìš©ë³€ê²½</span>' : ''}</h3>
                            <p><b>ğŸ“ ê°•ì˜ ì£¼ì†Œ</b> <span class="${hlAddr}">${data.address}</span></p>
                            <p><b>ğŸ« êµìœ¡ ì¥ì†Œ</b> <span class="${hlRoom}">${data.classRoom || 'ë¯¸ì •'}</span></p>
                            <div style="margin-top:10px; font-weight:bold;">ğŸ“† êµìœ¡ ì¼ì •</div>
                            <div class="${hlSch}">
                                <div class="schedule-list">
                                    ${data.date.split(', ').map((dt, i) => `<div>ğŸ“… ${dt} â° ${data.time.split(', ')[i]}</div>`).join('')}
                                </div>
                            </div>
                            <p class="total-pay"><b>ğŸ’µ ì´ ê°•ì‚¬ë£Œ</b> <span class="${hlMoney}">${totalPay.toLocaleString()}ì›</span></p>
                            <div style="display:flex; gap:10px; margin-top:15px;">
                                <div class="status-box ${data.isPaidTeacher?'status-complete':'status-waiting'}">ê°•ì‚¬ë£Œ ${data.isPaidTeacher?'ì™„ë£Œ':'ëŒ€ê¸°'}</div>
                                <div class="status-box ${data.isPaidService?'status-complete':'status-waiting'}">ì„œë¹„ìŠ¤ë£Œ ${data.isPaidService?'ì™„ë£Œ':'ëŒ€ê¸°'}</div>
                            </div>
                            ${isConfirmed ? '<span class="confirmed-msg">í™•ì¸ì™„ë£Œ</span>' : `<button class="check-btn" onclick="confirmAssignment('${d.id}')">ë‚´ìš© í™•ì¸ ë° ë°°ì •ìˆ˜ë½</button>`}
                        </div>`;
                });
                document.getElementById('card-view-container').innerHTML = cardHtml || "ë‚´ì—­ ì—†ìŒ";
            });
        }

        window.confirmAssignment = async (id) => {
            if(confirm("ë‚´ìš©ì„ í™•ì¸í•˜ì…¨ìŠµë‹ˆê¹Œ?")) {
                // ğŸ”¥ í™•ì¸ ì‹œ ëª¨ë“  ë³€ê²½ í”Œë˜ê·¸ ì´ˆê¸°í™”
                await updateDoc(doc(db, "assignments", id), { 
                    status: "í™•ì¸ì™„ë£Œ", 
                    isUpdated: false,
                    changed_address: false,
                    changed_classRoom: false,
                    changed_schedule: false,
                    changed_money: false
                });
            }
        }
    </script>
</body>
</html>