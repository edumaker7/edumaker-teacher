<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ë“€ë©”ì´ì»¤</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f4f8; margin: 0; padding: 0; }
        .header { background-color: #0056b3; color: white; padding: 20px; text-align: center; }
        .container { max-width: 900px; margin: 30px auto; padding: 0 20px; }
        .welcome-msg { font-size: 18px; margin-bottom: 25px; color: #333; font-weight: 600; display: inline-block; }
        .assignment-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-top: 5px solid #0056b3; }
        .card h3 { margin-top: 0; color: #0056b3; font-size: 20px; border-bottom: 1px solid #eee; padding-bottom: 12px; display: flex; align-items: center; }
        .card h3::before { content: 'ğŸ« '; margin-right: 5px; }
        .card p { margin: 10px 0; font-size: 15px; color: #555; display: flex; align-items: flex-start; }
        .card b { color: #333; width: 130px; flex-shrink: 0; }
        .note-box { background-color: #fef9e7; border-left: 4px solid #f1c40f; padding: 12px; margin-top: 15px; font-size: 14px; border-radius: 4px; color: #666; line-height: 1.5; }
        .pay-status-row { display: flex; gap: 8px; margin-top: 15px; }
        .status-box { flex: 1; padding: 10px 5px; text-align: center; border-radius: 8px; font-weight: bold; font-size: 11px; transition: 0.3s; box-sizing: border-box; }
        .status-waiting { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-complete { background-color: #e9ecef; color: #6c757d; border: 1px solid #dee2e6; }
        .check-btn { width: 100%; padding: 14px; margin-top: 15px; background-color: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; line-height: 1.4; }
        .check-btn small { display: block; font-size: 11px; font-weight: normal; opacity: 0.9; }
        .confirmed-msg { display: block; margin-top: 15px; padding: 14px; text-align: center; background-color: #f8f9fa; color: #adb5bd; border-radius: 8px; font-weight: bold; font-size: 14px; }
        .logout-btn { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; float: right; font-size: 14px; }
    </style>
</head>
<body>
    <div class="header"><h1>EDUMAKER ê°•ì‚¬ ì „ìš©</h1></div>
    <div class="container">
        <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        <div id="welcome-text" class="welcome-msg">ê°•ì‚¬ë‹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div id="assignment-list" class="assignment-grid"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, orderBy, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDKA0GjAlOF826TZl49y67H4oz8nMW_Jbw",
            authDomain: "edumaker-teacher-d97ba.firebaseapp.com",
            projectId: "edumaker-teacher-d97ba",
            storageBucket: "edumaker-teacher-d97ba.firebasestorage.app",
            messagingSenderId: "532708143359",
            appId: "1:532708143359:web:89b9933da4c868127ddcca",
            measurementId: "G-JJ1TF77VBJ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    /* [DB í•„ë“œ í˜¸ì¶œ ê°€ì´ë“œ - 'users' ì»¬ë ‰ì…˜]
                       1. email : ì‚¬ìš©ì ì‹ë³„ ì´ë©”ì¼
                       2. name  : ê°•ì‚¬ ì‹¤ëª… í‘œì‹œìš©
                    */
                    const userQuery = query(collection(db, "users"), where("email", "==", user.email));
                    const userSnapshot = await getDocs(userQuery);
                    let displayName = "ê°•ì‚¬";
                    if (!userSnapshot.empty) {
                        displayName = userSnapshot.docs[0].data().name;
                    }
                    document.getElementById('welcome-text').innerHTML = `âœ¨ <b>${displayName}(${user.email})</b> ê°•ì‚¬ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
                } catch (e) {
                    document.getElementById('welcome-text').innerText = `âœ¨ ${user.email} ê°•ì‚¬ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`;
                }
                listenAssignments(user.email);
            } else { 
                // ë¡œê·¸ì¸ ì„¸ì…˜ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = "index.html"; 
            }
        });

        function listenAssignments(email) {
            const listDiv = document.getElementById('assignment-list');
            /* [DB í•„ë“œ ê°€ì´ë“œ - 'assignments' ì»¬ë ‰ì…˜] 
               ë³¸ì¸ ì´ë©”ì¼(teacherEmail)ê³¼ ì¼ì¹˜í•˜ëŠ” ë°ì´í„°ë§Œ ì‹¤ì‹œê°„ ê°ì‹œ
            */
            const q = query(collection(db, "assignments"), where("teacherEmail", "==", email), orderBy("createdAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                let html = "";
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const docId = docSnap.id;

                    /* í˜¸ì¶œ í•„ë“œ ìƒì„¸ (admin.html ì €ì¥ ê¸°ì¤€)
                       - client : ê°•ì˜ì²˜
                       - subject : ê°•ì¢Œëª…
                       - role : ì—­í• 
                       - date : ì¼ì
                       - time : ì‹œê°„
                       - classHours : ê°•ì˜ì‹œê°„
                       - hourlyRate : ì‹œê°„ë‹¹ ê°•ì‚¬ë£Œ
                       - serviceFee : ì„œë¹„ìŠ¤ ì´ìš©ë£Œ
                       - commissionRate : ìˆ˜ìˆ˜ë£Œìœ¨
                       - note : ë¹„ê³ 
                       - status : í™•ì¸ì™„ë£Œ ì—¬ë¶€
                       - isPaidTeacher : ê°•ì‚¬ë£Œ ì •ì‚°ì—¬ë¶€
                       - isPaidService : ì„œë¹„ìŠ¤ì´ìš©ë£Œ ì •ì‚°ì—¬ë¶€
                    */
                    
                    const totalGrossPay = (data.classHours || 0) * (data.hourlyRate || 0);
                    
                    const teacherPaidClass = data.isPaidTeacher ? 'status-complete' : 'status-waiting';
                    const teacherPaidText = data.isPaidTeacher ? 'âœ… ê°•ì‚¬ë£Œ ì •ì‚°ì™„ë£Œ' : 'âŒ› ê°•ì‚¬ë£Œ ì •ì‚°ëŒ€ê¸°';
                    const servicePaidClass = data.isPaidService ? 'status-complete' : 'status-waiting';
                    const servicePaidText = data.isPaidService ? 'âœ… ì„œë¹„ìŠ¤ì´ìš©ë£Œ í™•ì¸' : 'âŒ› ì„œë¹„ìŠ¤ì´ìš©ë£Œ ëŒ€ê¸°';

                    html += `
                        <div class="card">
                            <h3>${data.client}</h3>
                            <p><b>ğŸ“š ê°•ì¢Œëª…</b> <span>: ${data.subject}</span></p>
                            <p><b>ğŸ–ï¸ ë°°ì •ì—­í• </b> <span>: ${data.role || 'ê°•ì‚¬'}</span></p>
                            <p><b>â° êµìœ¡ì¼ì</b> <span>: ${data.date}</span></p>
                            <p><b>â±ï¸ êµìœ¡ì‹œê°„</b> <span>: ${data.time} (${data.classHours}ì‹œê°„)</span></p>
                            <p><b>ğŸ’° ì‹œê°„ë‹¹ ê°•ì‚¬ë£Œ</b> <span>: ${Number(data.hourlyRate || 0).toLocaleString()}ì›</span></p>
                            <p><b>ğŸ’µ ì´ ê°•ì‚¬ë£Œ</b> <span>: ${totalGrossPay.toLocaleString()}ì›</span></p>
                            <p><b>ğŸ·ï¸ ì„œë¹„ìŠ¤ ì´ìš©ë£Œ</b> <span>: -${(data.serviceFee || 0).toLocaleString()}ì› (${data.commissionRate}%)</span></p>
                            
                            ${data.note ? `<div class="note-box"><b>ğŸ“ ë¹„ê³ (ê¸°íƒ€)</b><br>${data.note.replace(/\n/g, '<br>')}</div>` : ''}

                            <div class="pay-status-row">
                                <div class="status-box ${teacherPaidClass}">
                                    ${teacherPaidText}
                                </div>
                                <div class="status-box ${servicePaidClass}">
                                    ${servicePaidText}
                                </div>
                            </div>

                            ${data.status === 'í™•ì¸ì™„ë£Œ' 
                                ? `<span class="confirmed-msg">ğŸ‘ ê°•ì˜ ë°°ì • í™•ì¸ ì™„ë£Œ</span>` 
                                : `<button class="check-btn" onclick="confirmAssignment('${docId}')">
                                    ê°•ì˜ ë°°ì • í™•ì¸í•˜ê¸°
                                    <small>(ë°°ì •ëœ ê°•ì˜ ë‚´ìš©ì„ í™•ì¸í•˜ì…¨ë‹¤ë©´ í´ë¦­í•´ ì£¼ì„¸ìš”)</small>
                                   </button>`}
                        </div>
                    `;
                });
                listDiv.innerHTML = html || '<div class="no-data">ë°°ì • ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            });
        }

        window.confirmAssignment = async (docId) => {
            if(!confirm("ê°•ì˜ ë°°ì • ë‚´ìš©ì„ í™•ì¸í•˜ì…¨ìŠµë‹ˆê¹Œ?")) return;
            // status í•„ë“œë¥¼ 'í™•ì¸ì™„ë£Œ'ë¡œ ì—…ë°ì´íŠ¸
            await updateDoc(doc(db, "assignments", docId), { status: "í™•ì¸ì™„ë£Œ" });
        }

        // ğŸ”¥ ë¡œê·¸ì•„ì›ƒ í›„ index.htmlë¡œ ì´ë™í•˜ë„ë¡ ìˆ˜ì •
        window.handleLogout = () => signOut(auth).then(() => {
            location.href = "index.html";
        });
    </script>
</body>
</html>